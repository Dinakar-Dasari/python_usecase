import boto3

# Create a custom AWS Identity and Access Management (IAM) policy and IAM role for your Lambda function.
# Create Lambda functions that stop and start your EC2 instances.
# Test your Lambda functions.
# Create EventBridge schedules that run your function on a schedule.

def instance_stop_by_tag(tags, region):
    filters = [{"Name": f'tag:{key}', "Values":[value]}for key,value in tags.items()]
    filters.append({'Name': "instance-state-name", "Values": ['running']})  # Include only running instances
    ec2 = boto3.client('ec2',region_name = region)
    response = ec2.describe_instances(Filters=filters)
    instances_id= []
    for instances in response["Reservations"]:
        for instance in instances["Instances"]:
            instances_id.append(instance["InstanceId"])
    print(instances_id)        



    

def lambda_handler(event, context):
    tags = {
        'Auto-instance-scheduler': 'yes',
        'environment': 'dev' 
        }
    region = "us-east-1"
    instance_stop_by_tag(tags,region)

lambda_handler("event","context")    

'''
{'Reservations': [{'Groups': [], 'Instances': [{'AmiLaunchIndex': 0, 'ImageId': 'ami-0c02fb55956c7d316', 'InstanceId': 'i-06821653732ae21db', 'InstanceType': 't3.micro', 'LaunchTime': datetime.datetime(2025, 11, 9, 14, 0, 44, tzinfo=tzutc()), 'Monitoring': {'State': 'disabled'}, 'Placement': {'AvailabilityZone': 'us-east-1a', 'GroupName': '', 'Tenancy': 'default'}, 'PrivateDnsName': 'ip-172-31-46-139.ec2.internal', 'PrivateIpAddress': '172.31.46.139', 'ProductCodes': [], 'PublicDnsName': 'ec2-52-23-154-64.compute-1.amazonaws.com', 'PublicIpAddress': '52.23.154.64', 'State': {'Code': 16, 'Name': 'running'}, 'StateTransitionReason': '', 'SubnetId': 'subnet-070a8260c319f0823', 'VpcId': 'vpc-0aec882b729119628', 'Architecture': 'x86_64', 'BlockDeviceMappings': [{'DeviceName': '/dev/xvda', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 9, 14, 0, 45, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-091e3332af2077c71'}}], 'ClientToken': '0f844a912ec5ec9ac8f5a5d7910a4c2fe1c3a01391c198399e6129819100', 'EbsOptimized': False, 'EnaSupport': True, 'Hypervisor': 'xen', 'InstanceLifecycle': 'spot', 'NetworkInterfaces': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': 'ec2-52-23-154-64.compute-1.amazonaws.com', 'PublicIp': '52.23.154.64'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 9, 14, 0, 44, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-03a91ae29d2184034', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'launch-wizard-1', 'GroupId': 'sg-0065fcf40f33776a5'}], 'Ipv6Addresses': [], 'MacAddress': '0e:2a:83:d4:c3:3b', 'NetworkInterfaceId': 'eni-07f0afd7ead5d6fae', 'OwnerId': '196061557685', 'PrivateDnsName': 'ip-172-31-46-139.ec2.internal', 'PrivateIpAddress': '172.31.46.139', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': 'ec2-52-23-154-64.compute-1.amazonaws.com', 'PublicIp': '52.23.154.64'}, 'Primary': True, 'PrivateDnsName': 'ip-172-31-46-139.ec2.internal', 'PrivateIpAddress': '172.31.46.139'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-070a8260c319f0823', 'VpcId': 'vpc-0aec882b729119628', 'InterfaceType': 'interface'}], 'RootDeviceName': '/dev/xvda', 'RootDeviceType': 'ebs', 'SecurityGroups': [{'GroupName': 'launch-wizard-1', 'GroupId': 'sg-0065fcf40f33776a5'}], 'SourceDestCheck': True, 'SpotInstanceRequestId': 'sir-ekzfbnrj', 'Tags': [{'Key': 'Auto-instance-scheduler', 'Value': 'yes'}, {'Key': 'Name', 'Value': 'ec2_test_instance_1'}, {'Key': 'environment', 'Value': 'dev'}], 'VirtualizationType': 'hvm', 'CpuOptions': {'CoreCount': 1, 'ThreadsPerCore': 2}, 'CapacityReservationSpecification': {'CapacityReservationPreference': 'open'}, 'HibernationOptions': {'Configured': False}, 'MetadataOptions': {'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, 'EnclaveOptions': {'Enabled': False}, 'PlatformDetails': 'Linux/UNIX', 'UsageOperation': 'RunInstances', 'UsageOperationUpdateTime': datetime.datetime(2025, 11, 9, 14, 0, 44, tzinfo=tzutc()), 'PrivateDnsNameOptions': {'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, 'MaintenanceOptions': {'AutoRecovery': 'default'}, 'CurrentInstanceBootMode': 'legacy-bios'}], 'OwnerId': '196061557685', 'RequesterId': '823129131983', 'ReservationId': 'r-0449858d75d8cfcfa'}, {'Groups': [], 'Instances': [{'AmiLaunchIndex': 0, 'ImageId': 'ami-0c02fb55956c7d316', 'InstanceId': 'i-03f7220ff96ce6db0', 'InstanceType': 't3.micro', 'LaunchTime': datetime.datetime(2025, 11, 9, 14, 38, 40, tzinfo=tzutc()), 'Monitoring': {'State': 'disabled'}, 'Placement': {'AvailabilityZone': 'us-east-1a', 'GroupName': '', 'Tenancy': 'default'}, 'PrivateDnsName': 'ip-172-31-47-116.ec2.internal', 'PrivateIpAddress': '172.31.47.116', 'ProductCodes': [], 'PublicDnsName': 'ec2-54-211-249-159.compute-1.amazonaws.com', 'PublicIpAddress': '54.211.249.159', 'State': {'Code': 16, 'Name': 'running'}, 'StateTransitionReason': '', 'SubnetId': 'subnet-070a8260c319f0823', 'VpcId': 'vpc-0aec882b729119628', 'Architecture': 'x86_64', 'BlockDeviceMappings': [{'DeviceName': '/dev/xvda', 'Ebs': {'AttachTime': datetime.datetime(2025, 11, 9, 14, 38, 41, tzinfo=tzutc()), 'DeleteOnTermination': True, 'Status': 'attached', 'VolumeId': 'vol-024fefb1d3d6f7390'}}], 'ClientToken': 'cd33180aa93fdd21571ccac7401b034f292f4a736e8dced8e4f52ddabbbe', 'EbsOptimized': False, 'EnaSupport': True, 'Hypervisor': 'xen', 'InstanceLifecycle': 'spot', 'NetworkInterfaces': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': 'ec2-54-211-249-159.compute-1.amazonaws.com', 'PublicIp': '54.211.249.159'}, 'Attachment': {'AttachTime': datetime.datetime(2025, 11, 9, 14, 38, 40, tzinfo=tzutc()), 'AttachmentId': 'eni-attach-06593c158cb75e09b', 'DeleteOnTermination': True, 'DeviceIndex': 0, 'Status': 'attached', 'NetworkCardIndex': 0}, 'Description': '', 'Groups': [{'GroupName': 'launch-wizard-1', 'GroupId': 'sg-0065fcf40f33776a5'}], 'Ipv6Addresses': [], 'MacAddress': '0e:c5:92:d1:71:55', 'NetworkInterfaceId': 'eni-095d625b31eece8b5', 'OwnerId': '196061557685', 'PrivateDnsName': 'ip-172-31-47-116.ec2.internal', 'PrivateIpAddress': '172.31.47.116', 'PrivateIpAddresses': [{'Association': {'IpOwnerId': 'amazon', 'PublicDnsName': 'ec2-54-211-249-159.compute-1.amazonaws.com', 'PublicIp': '54.211.249.159'}, 'Primary': True, 'PrivateDnsName': 'ip-172-31-47-116.ec2.internal', 'PrivateIpAddress': '172.31.47.116'}], 'SourceDestCheck': True, 'Status': 'in-use', 'SubnetId': 'subnet-070a8260c319f0823', 'VpcId': 'vpc-0aec882b729119628', 'InterfaceType': 'interface'}], 'RootDeviceName': '/dev/xvda', 'RootDeviceType': 'ebs', 'SecurityGroups': [{'GroupName': 'launch-wizard-1', 'GroupId': 'sg-0065fcf40f33776a5'}], 'SourceDestCheck': True, 'SpotInstanceRequestId': 'sir-j7dz8xqj', 'Tags': [{'Key': 'Auto-instance-scheduler', 'Value': 'yes'}, {'Key': 'Name', 'Value': 'ec2_test_instance_2'}, {'Key': 'environment', 'Value': 'dev'}], 'VirtualizationType': 'hvm', 'CpuOptions': {'CoreCount': 1, 'ThreadsPerCore': 2}, 'CapacityReservationSpecification': {'CapacityReservationPreference': 'open'}, 'HibernationOptions': {'Configured': False}, 'MetadataOptions': {'State': 'applied', 'HttpTokens': 'optional', 'HttpPutResponseHopLimit': 1, 'HttpEndpoint': 'enabled', 'HttpProtocolIpv6': 'disabled', 'InstanceMetadataTags': 'disabled'}, 'EnclaveOptions': {'Enabled': False}, 'PlatformDetails': 'Linux/UNIX', 'UsageOperation': 'RunInstances', 'UsageOperationUpdateTime': datetime.datetime(2025, 11, 9, 14, 38, 40, tzinfo=tzutc()), 'PrivateDnsNameOptions': {'HostnameType': 'ip-name', 'EnableResourceNameDnsARecord': False, 'EnableResourceNameDnsAAAARecord': False}, 'MaintenanceOptions': {'AutoRecovery': 'default'}, 'CurrentInstanceBootMode': 'legacy-bios'}], 'OwnerId': '196061557685', 'RequesterId': '823129131983', 'ReservationId': 'r-00ce38fb571ef25de'}], 'ResponseMetadata': {'RequestId': '80926021-f92a-4c91-b9d6-484ab3e0035c', 'HTTPStatusCode': 200, 'HTTPHeaders': {'x-amzn-requestid': '80926021-f92a-4c91-b9d6-484ab3e0035c', 'cache-control': 'no-cache, no-store', 'strict-transport-security': 'max-age=31536000; includeSubDomains', 'vary': 'accept-encoding', 'content-type': 'text/xml;charset=UTF-8', 'transfer-encoding': 'chunked', 'date': 'Sun, 09 Nov 2025 14:39:59 GMT', 'server': 'AmazonEC2'}, 'RetryAttempts': 0}} '''